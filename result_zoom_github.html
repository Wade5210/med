
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ é¡¯ç¤ºè—¥å–®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #f0f9ff;
      padding: 20px;
      text-align: center;
    }
    table {
      border-collapse: collapse;
      margin: 20px auto;
      width: 90%;
      background: white;
      box-shadow: 0 0 10px #ccc;
      border-radius: 12px;
    }
    th, td {
      border: 1px solid rgba(0,0,0,0.05);
    }
    td:nth-child(2) {
      text-align: left;
      padding-left: 12px;
    }
    th {
      background: #1976d2;
      color: white;
    }
    .btn {
      background: #2e7d32;
      color: white;
      padding: 10px 20px;
      border: none;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 8px;
    }
    .med-image {
      width: 60px;
      border-radius: 6px;
      cursor: zoom-in;
    }
    #modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.8);
    }
    #modal img {
      margin-top: 5%;
      max-width: 90%;
      max-height: 90%;
    }
    .cancelled {
      background-color: #dcdcdc;
      color: #555;
    }
    #errorBox {
      color: red;
      font-size: 18px;
      margin: 10px;
    }
     #rxInfo {
  text-align: left;
  max-width: 720px;
  margin: 0 auto 12px;
  font-size: 18px;
  line-height: 1.6;
  padding: 0 10px;
}

.info-top {
  display: flex;
  justify-content: space-between;
  font-weight: 500;
  color: #424242;
  background: #fffde7;
  padding: 8px 12px;
  border-top-left-radius: 12px;
  border-top-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border-bottom: 1px solid #ddd;
}

.info-bottom {
  text-align: right;
  color: #424242;
  background: #fffde7;
  padding: 8px 12px;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-top: -1px; /* è²¼é½Šä¸Šæ–¹ */
}
 @media (max-width: 768px) {
  body {
    padding: 10px;
  }

  table {
    width: 98%;
    border-radius: 0;
    box-shadow: none;
  }

  th, td {
    font-size: 20px;
    padding: 8px;
  }

  .btn-row {
    display: flex;
    flex-direction: row;         /* ğŸ’¡ æ©«å‘æ’åˆ— */
    justify-content: center;     /* æ°´å¹³ç½®ä¸­ */
    flex-wrap: wrap;             /* æ›è¡Œï¼ˆè‹¥è¢å¹•å¤ªå°ï¼‰ */
    gap: 12px;
  }

  .btn {
    flex: 1 1 45%;               /* æ¯é¡†æŒ‰éˆ•ä½”ä¸€åŠå¯¬ */
    font-size: 18px;
    padding: 12px 10px;
    box-sizing: border-box;
  }

  .med-image {
    width: 48px;
  }
}


  </style>
</head>
<body>
  <p id="rxInfo"></p>
  <p id="errorBox"></p>
  <div style="text-align: right;">
    <p id="countDisplay"></p>
  </div>
  <div style="overflow-x:auto;">
    <table id="resultTable" style="display:none;">
      <tbody id="medBody"></tbody>
    </table>
  </div>

  
  <button class="btn" id="toggleBtn" onclick="toggleAll()">å…¨éƒ¨å–æ¶ˆç°½æ”¶</button>
  <button class="btn" onclick="location.href='https://wade5210.github.io/med/scan_zoom_github.html'">ğŸ”„ ç¹¼çºŒæƒæ</button>


  <div id="modal" onclick="this.style.display='none'">
    <img id="modal-img" src="" alt="æ”¾å¤§åœ–ç‰‡" />
  </div>

<script>
  const defaultImg = "https://i.imgur.com/POcLxgF.png";
  const params = new URLSearchParams(location.search);
  const barcode = params.get("barcode");
  const token = localStorage.getItem("token");
  const ward = localStorage.getItem("ward");
  const empCode = localStorage.getItem("empCode");
  let allChecked = true;

  if (!ward || !barcode || !token || !empCode) {
    document.getElementById("errorBox").textContent = "âŒ ç¼ºå°‘å¿…è¦è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥æˆ–æƒæ";
  } else {
document.getElementById("rxInfo").innerHTML = `
  <div class="info-top">
    è­·ç†ç«™ï¼š<strong>${ward}</strong>  äººå“¡ï¼š<strong>${empCode}</strong>
  </div>
  <div class="info-bottom">
    é†«å›‘è™Ÿï¼š<strong>${barcode}</strong>
  </div>
`;

    fetch(`https://mdevws.csh.org.tw/WebAPI/MedicationConfirm/Medication/DrugList?ward=${ward}&barcode=${barcode}&empCode=${empCode}`, {
      headers: {
        Authorization: token,
        Accept: "application/json"
      }
    })
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById("medBody");
      const table = document.getElementById("resultTable");

      if (typeof data.content === "string") {
        document.getElementById("errorBox").textContent = "âš ï¸ " + data.content;
        return;
      }

      const meds = Array.isArray(data?.content) ? data.content : [];

      if (meds.length === 0) {
        document.getElementById("errorBox").textContent = "âŒ æŸ¥ç„¡è—¥å“è³‡æ–™";
        return;
      }

      meds.forEach(med => {
        const tr = document.createElement("tr");
        tr.setAttribute("data-code", med.ItemNo);  // ç¶å®šè—¥å“ä»£ç¢¼

        tr.innerHTML = `
          <td><img src="${med.ImageUrl}" class="med-image" onclick="zoomImage(this.src)" onerror="this.src='${defaultImg}'"></td>
          <td>${med.ItemName}</td>
          <td>${med.TotQty}</td>
          <td><input type="checkbox" class="chkbox" onchange="handleCheckbox(this)" checked></td>
        `;

        tbody.appendChild(tr);
        handleCheckbox(tr.querySelector("input"));
      });

      table.style.display = "table";
      updateCount();
    })
    .catch(() => {
      document.getElementById("errorBox").textContent = "âŒ è—¥å“è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    });
  }

  function handleCheckbox(cb) {
    const tr = cb.closest("tr");
    tr.classList.toggle("cancelled", !cb.checked);
    updateCount();

    if (!cb.checked) {
      const itemCode = tr.getAttribute("data-code");

      const body = {
        BarCode: barcode,
        ItemCode: itemCode,
        SignUser: empCode
      };

      fetch("https://mdevws.csh.org.tw/WebAPI/MedicationConfirm/Medication/DeleteDrugTranLog", {
        method: "POST",
        headers: {
          Authorization: token,
          Accept: "application/json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      })
      .then(res => res.json())
      .then(result => {
        console.log("âœ… å·²å–æ¶ˆç°½æ”¶ï¼š", result);
      })
      .catch(err => {
        console.error("âŒ å–æ¶ˆç°½æ”¶å¤±æ•—ï¼š", err);
      });
    }
  }

  function updateCount() {
    const all = document.querySelectorAll(".chkbox").length;
    const checked = document.querySelectorAll(".chkbox:checked").length;
    document.getElementById("countDisplay").textContent = `âœ… å·²ç°½æ”¶ ${checked} / ${all}`;
  }

  function zoomImage(src) {
    document.getElementById("modal-img").src = src;
    document.getElementById("modal").style.display = "block";
  }

  function toggleAll() {
    const boxes = document.querySelectorAll(".chkbox");
    allChecked = !allChecked;
    document.getElementById("toggleBtn").textContent = allChecked ? "å…¨éƒ¨å–æ¶ˆç°½æ”¶" : "å…¨éƒ¨å‹¾é¸";
    boxes.forEach(cb => {
      cb.checked = allChecked;
      cb.dispatchEvent(new Event("change")); // ç¢ºä¿è§¸ç™¼ onchange è™•ç†
    });
  }

</script>
</body>
</html>
